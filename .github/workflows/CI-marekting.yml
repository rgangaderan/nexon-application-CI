on:
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:
      - main    
      - dev
      - 'releases/**'

jobs:
  Docker-Login:
    runs-on: self-hosted
    name: Login
    defaults:
      run:
        shell: bash
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v2
      - 
        env:
          ECR_REGION: us-east-1
          ECR_PROFILE: nexon-dev
        name: "docker_login"
        run: |
            aws ecr get-login-password --region $ECR_REGION --profile $ECR_PROFILE | docker login --username AWS --password-stdin 126609036647.dkr.ecr.us-east-1.amazonaws.com

  Build:
    runs-on: self-hosted
    name: Nexon Marketing Application Build

    defaults:
      run:
        shell: bash
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v2
      - 
        name: "build"
        run: |
            docker build -t nexon-marketing:$(cat version.sh | cut -c 9-) ./nexon-marketing-CI
    needs: [Docker-Login]

  Push:
    runs-on: self-hosted
    name: Nexon Apllication Push

    defaults:
      run:
        shell: bash
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v2
      - 
        name: "push"
        env:
          VERSION: $(cat nexon-marketing-CI/version.sh | cut -c 9-)
        run: |
            docker tag nexon-marketing:$VERSION 126609036647.dkr.ecr.us-east-1.amazonaws.com/nexon-development-zgqad:$VERSION
            docker push 126609036647.dkr.ecr.us-east-1.amazonaws.com/nexon-development-zgqad:$VERSION
    needs: [Build]
